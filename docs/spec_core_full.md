# World Groove Ornament Sequencer 仕様（フル版）

この文書は、これまでチャットで決めてきた内容を出来るだけ漏れなく 1 本にまとめた **フル仕様テキスト**です。`world-groove-sequencer-full` リポジトリの `docs/spec_core.md` を上書きする用途を想定しています。

---

## 0. 目的と全体像

- 見た目は普通の **16 step × 2 小節** ステップシーケンサー。
- 各ステップは **オーナメント（装飾音符）** を内部に持つ「ミニシーケンサー」。
- 時間軸（グリッド）は見た目上は一定だが、内部では
  - グルーヴ（GrvDepth）
  - スワップフェーダー
  - オーナメント
  によって「ぐにゃぐにゃに歪んだグリッド」として振る舞う。
- さらに、ライブパフォーマンス中の結果フレーズを   **Live Take シーケンサー**として録音・ループ再生できる。
- すべてのパート（ドラム / ベース / リード etc）は、
  - オーナメントシーケンサー
  - Live Take シーケンサー
  をモザイク状に貼り合わせながら楽曲を構成できる。

キーワード：

- 身体性、没入、リアルタイム性
- 「設計」ではなく「遊び」から曲が生まれる
- 管理コストを上げない（オートメーションは録らない）

---

## 1. 時間スケールとパターンの基本構造

### 1.1 グローバルなグリッド

- 基本パターン長：**2 小節**
- 1 小節あたり **16 step** → 1 パターンあたり **32 step**
- すべてのトラックがこのグリッドを共有する。

### 1.2 レーン（トラック）ごとの時間スケール `timeScale`

- 各トラックは `timeScale` を持つ：

  - 1.0 … グリッド通り、2 小節で 32 step を 1 周
  - 0.5 … 同じ 32 step パターンが **4 小節**かけて 1 周
  - 0.25 … 同じ 32 step パターンが **8 小節**かけて 1 周

- 編集ビューでは常に「16 step × 2 小節」の幅で見える。
- 実時間的な長さは `timeScale` によって変わる。

> 例：  
> ドラム = timeScale 1.0（2 小節ループ）  
> ベース = 0.5（4 小節で 1 周）  
> リード = 0.25（8 小節で 1 周）

### 1.3 A/B ループ構造

- 1 小節目：A
- 2 小節目：B
- 再生時は、A/B の比率をパターンごとに持てる：
  - 例：3:1, 2:2, 7:1, 5:3, …
- これは「最小単位は 16 step だが、2 小節パターンを   ミニマルに繰り返して崩していく」ための土台。

---

## 2. オーナメントシーケンサー

### 2.1 オーナメントとは

- 各 step は `ornament` を 1 つ持つ。
- `ornament` は「ステップ内部にあるミニシーケンス」。

```text
Step (グリッド上の1マス)
 └ Ornament (time, pitch, vel, dur...) の集合
```

- プレーンな 1 音も、内部的にはオーナメントの 1 イベントとして表現。

### 2.2 データ構造のイメージ

- `Step`
  - `hasNote: boolean`
  - `basePitch: number | null`
  - `velocity: number`
  - `gate: number`
  - `active: boolean`
  - `ornament: Ornament`

- `Ornament`
  - `mode: "plain" | "extended"`
  - `internalDuration: number`（step 内部時間の長さ）
  - `followMode: "overlap" | "cut" | "wait"`
  - `playMode: "oneShot" | "loop" | "loopRoll"`
  - `loopCount: number | "infinite" | null`
  - `events: OrnamentEvent[]`

- `OrnamentEvent`
  - `t: number`（0〜internalDuration の範囲）
  - `pitch: number`
  - `vel: number`
  - `dur: number`

### 2.3 followMode（次のステップとの関係）

- `overlap`  
  → オーナメントが次の step に食い込んでも、次の step は予定通り鳴る。  
- `cut`  
  → 次の step が来た瞬間に、オーナメントを強制終了。  
- `wait`  
  → オーナメントが鳴き終わるまで「次の step の開始そのものが遅れる」。  
    インド音楽のティハイ的な効果や、「オーナメントが拍を奪う」挙動を作る。

### 2.4 playMode（オーナメント自体の再生方法）

- `oneShot`：1 回だけ鳴る。
- `loop`：指定回数ループ。
- `loopRoll`：DJ ソフトの Loop Roll のように、
  - ループ中もグローバルタイムは進み
  - 解除すると「本来いる位置」に瞬間復帰する。

### 2.5 編集画面（オーナメント編集）

- 指で「顔を変形するアプリ」のように装飾を編集できる。

機能イメージ：

- 時間 × ピッチの 2D カーブビュー。
- ドラッグ：ノートの時間とピッチを同時に動かす。
- ピンチ：時間軸のズーム。
- ストレッチジェスチャー：区間を伸縮。
- 軽いシャッフル：小さな範囲内で順番を入れ替える。

> ここはガチ DAW ではなく「遊びながら変な装飾を生み出す」UI を優先。

### 2.6 オーナメントパターン数

- 各トラックは 2 小節パターンを：
  - **16 パターン × 8 バンク = 128 パターン**
  持つ。
- これらを「オーナメントシーケンサーのパターンバンク」として、
  ドラム / ベース / リード全てが共有可能。

---

## 3. ノートスワップ & スワップフェーダー

### 3.1 プレイスタイルとしてのノートスワップ

- ノートスワップは **モードではなく演奏スタイル** として定義する。
- 演奏中に：
  - ステップをタップしてノートミュート
  - ミュートされずに残ったノート群だけが「スワップの対象」になる。

> ミュートで素材選別 → フェーダーで順番シャッフル、という > 2 段階のプレイ。

### 3.2 スワップスタイルボタン + フェーダー

- スワップの「系」はボタンで切り替え：

  - A：Neighbor Swap（近所との軽い入れ替え）
  - B：Rotate Shift（循環シフト）
  - C：Block Swap（4 step 単位などのブロックを入れ替え）
  - D：Odd Loop / Odd Grid（3/5/7 step 単位で変則ループ）
  - E：Chaos-ish（局所カオス）

- 1 本のフェーダーで「その系の中の深さ」を探索：
  - 0% 付近：ほぼ原型
  - 中間：部分的な入れ替え
  - 100% 付近：かなり変態的な並び

> ボタン = 世界線の切り替え  
> フェーダー = その世界の中を旅するための位置決め

### 3.3 スワップ対象のルール

- 対象ステップ：
  - `hasNote = true`
  - `active = true`
  - ミュートされていない
- 同じトラック内で完結（他トラックとのスワップはしない）。
- オーナメントを持つステップは「塊」として扱い、丸ごと位置を入れ替える。

---

## 4. グルーヴ（GrvDepth） & 変態テンプレート

### 4.1 GrvDepth

- 各レーン、またはグローバルに `GrvDepth` を持つ。

  - 0%：グリッド通り
  - ±100%：一般的なスウィング〜シャッフル
  - ±800% まで拡張し、かなり極端なマイクロタイムを許す

- グルーヴパターンは JSON などでライブラリ化：

  - Amapiano 的
  - Gqom 的
  - 各国の民俗リズム由来のオフセット etc.

### 4.2 変態テンプレート（例）

- キックは 4 つ打ち固定、ハットだけが：
  - 1 小節を 3 分割 / 5 分割 / 7 分割などに再配置
  - 拍の中の細分化が live でフェーダーから切り替え可能
- timeScale + グルーヴ + Step Loop を組み合わせたプリセットを用意し、
  ユーザーが即呼び出せるようにする。

> 変態案はすべてテンプレート化し、「呼べばすぐ鳴る」状態にしておく。

---

## 5. Live Take シーケンサー

### 5.1 哲学

- Live Take は「操作」ではなく **結果のノート列だけ** を録音する。
- オートメーションや UI の状態は記録しない。
- 複雑なオーナメントやスワップの結果も、すべて   「普通の音符列」としてフラットにキャプチャする。
- 管理を軽く保ちつつ、最高の瞬間を再利用できる仕組み。

### 5.2 録音対象

- `LiveNote`
  - `time` … パターン開始からの絶対時間 or 拍単位位置
  - `pitch` … MIDI ノート番号等
  - `gate` … 実際のゲート長
  - `velocity` … 出力ベロシティ

- オーナメント内部のノートも、スワップでずれたノートも、  すべて「実際に鳴った順」に記録。

### 5.3 Live Take に対して許可する変形

Live Take は軽量性を保つため、変形は限定：

- ✅ GrvDepth によるグルーヴ歪み
- ✅ `timeScale`（0.5x / 1x / 2x 程度）
- ✅ Step Loop（どの区間をループするか）
- ✅ 全体シフト（前ノリ / 後ノリ）
- ✅ 全体トランスポーズ（半音単位）

以下は **Live Take ではやらない**：

- ❌ オーナメント内部の再編集
- ❌ スワップフェーダーによる再ハチャメチャ化
- ❌ 新たな装飾レイヤーの追加

> 変態的な崩しはオーナメント側に集約し、> Live Take は「結果フレーズを軽く揺らすだけ」の存在にする。

### 5.4 利用パターン

- ドラム + ベースをオーナメントパターンで回しながら、  シンセリードを鍵盤で長く手弾き → Live Take として録音。
- ドラムパターン遊びの「ベスト状態」を Live Take に焼き付け、  そのあと手を離してシンセの FM 変調をツマミで攻める。

---

## 6. ライブパフォーマンス画面

### 6.1 3 ブロック構成

```text
┌──────────────────────┐
│ ① Performance Controls│  ← ボタン群
├──────────────────────┤
│ ② Faders & Knobs      │  ← Swap Fader / Ornament / Groove etc.
├──────────────────────┤
│ ③ Mini Sequencer      │  ← 簡易グリッド表示 + ミュート
└──────────────────────┘
```

### 6.2 主な要素

- 上段（Performance Controls）
  - トラック Mute / Solo ボタン
  - スワップスタイルボタン A〜E
  - Step Loop パターンボタン
  - Tempo ± / Nudge ボタン
  - Live Take REC / PLAY 切り替えボタン

- 中段（Faders & Knobs）
  - Swap Fader（中央・一番大きい）
  - Lane 別 Ornament ノブ
  - GrvDepth ノブ
  - Step Length ノブ（activeLength）
  - Shift ノブ（レーンの前後オフセット）

- 下段（Mini Sequencer）
  - 16〜32 ステップ分の簡易表示
  - タップでノートミュート
  - オーナメント付きステップは ◎ などで表示

### 6.3 編集画面との関係

- 編集画面 ↔ ライブ画面 は 1 タップで行き来。
- 編集画面：
  - パターン構築、オーナメント編集、Live Take のピアノロール編集。
- ライブ画面：
  - ミュート、スワップ、グルーヴ、Live Take 切り替えなど、即興重視。

---

## 7. ソングモードとモザイク構造

### 7.1 パターンベースのソングモード

- 各トラックは 2 小節パターン（128 個）を参照して楽曲を組む。
- ライブ演奏中に：
  - どのパターンをどれだけ繰り返したか
  - どのタイミングで切り替えたか
  を記録 → SongStructure に反映。

### 7.2 Live Take とオーナメントのモザイク

- 1 つのトラック上で：

  - セクション A：オーナメントパターン
  - セクション B：Live Take
  - セクション C：再びオーナメント

- 実装的には `TrackSegment` の `type` を：
  - `"pattern"` or `"livetake"` として持つ。

### 7.3 （将来案）コードトラック

- ソングモードに「コード / スケールトラック」を追加し、
  ノートを持つトラックの音階を拘束する構想がある。
- ミュートすると拘束が外れる。
- 難しい場合は、上・下にピッチシフトを与える簡易版として実現する案もある。

---

## 8. 保存・ファイル名ルール

### 8.1 自動命名

- SAVE ボタンを押すだけで保存できる。
- ユーザーに名前入力させない。
- ID 形式：`{lanePrefix}_{serial}{sub}`

  - 例：`bs_012a`, `dr_021`, `sd_007` など。

- `lanePrefix` 例：
  - `bs` … Bass
  - `dr` … Drum
  - `kd` … Kick
  - `sd` … Snare
  - `pc` … Perc
  - `ld` … Lead
  - `ch` … Chord
  - `fx` … Noise / FX

### 8.2 LIKE / UNLIKE

- 👍 ボタンで「好き度」をカウント（0〜3 など）。
- 👎 ボタンで 0 に戻す、または「低優先」フラグ。
- ライブラリ表示は：
  - レーン種別（色・アイコン）
  - ID
  - LIKE レベル
  に絞り、文字ラベルは最小限。

---

## 9. 実装上の境界（どこまでやるか）

- オーナメントは強力だが、イベント数に上限を設ける（例：1 ステップ最大 8〜16 イベントなど）。
- Live Take はあくまで単純なノート列であり、オートメーションや装飾レイヤーは持たない。
- スワップ・グルーヴ系は「再生直前のビュー変換」として実装し、  生データはできるだけ書き換えない。
- Android と Windows タブレットの両方で動作させることを想定し、
  計算コストを意識したアルゴリズムを選ぶ。

---

## 10. 今後の拡張候補（メモ）

- コード / スケールトラックの実装。
- オーナメントプリセットに民族音楽装飾セットを大量追加。
- Live Take から「気に入りすぎたフレーズ」を   通常パターンに昇格させる機能（Promote to Pattern）。
- スワップエンジンの各モードの細部アルゴリズム設計。

