# World Groove Ornament Sequencer 仕様 v0.3

## 目次

1. コンセプト & 哲学
2. 時間スケール設計
3. オーナメントシーケンサー（Ornament Sequencer）
4. Live Take シーケンサー
5. ノートスワップ & スワップフェーダー
6. ライブパフォーマンス画面（Live Performance View）
7. ソングモード & パターン構造
8. 保存・ファイル名ルール
9. 実装者向けメモ（軽量性・複雑さの境界）
10. 付録：今後拡張予定の変態テンプレート群（ドラフト）

---

## 1. コンセプト & 哲学

- 見た目は **16step × 2小節** のごく普通のステップシーケンサー。
- しかし各ステップには、内部に複数ノートとマイクロタイムを持つ
  **オーナメント（装飾音符）オブジェクト**を標準装備する。
- 全レーンで **同じグリッド（16step × 2小節）** を使用するが、
  レーンごとに **時間スケール（timeScale）** を変えることで、
  ドラム・ベース・メロディなど異なる時間感覚を重ねる。
- 身体性を重視し、**リアルタイム演奏中の遊び行為**から
  新しいパターンを Live Take としてキャプチャする。
- 管理の複雑化を避けるため、Live Take は
  **「最終的にシーケンサーから出力されたノート列」だけを録音**し、
  オートメーションや内部状態は録音しない。
- 保存時にユーザーに名前入力を強要せず、
  レーン由来の短い ID（`bs_012a` など）で自動命名する。

---

## 2. 時間スケール設計

### 2.1 グローバルな基本単位

- 基本パターン幅：**2小節（patternLength = 2 bars）**
- グリッド：**16 step / bar → 32 step / pattern**
- 全レーンがこの同じグリッドを共有する。

### 2.2 レーンごとの時間スケール

各レーンは `timeScale` を持つ：

- `1.0x` … ドラム系レーン（実時間でも2小節）
- `0.5x` … ベースなど、同じ 32 step が **4小節**かけて再生される
- `0.25x` … メロディや長いパッドなど、**8小節**かけて再生される

> 編集スケールは常に「16step×2小節」で統一しつつ、
> レーンごとの timeScale で実時間的な長さだけを変える。

### 2.3 デフォルトループ構造（A/B パターン）

- 1小節目：A
- 2小節目：B
- 再生ルール：A/B のループ比を持つ（例：3:1, 2:2, 7:1など）

これは **ミニマルループエンジン** として機能し、
グローバルなループフィールを作る。

---

## 3. オーナメントシーケンサー（Ornament Sequencer）

### 3.1 オーナメントの基本

- 各ステップは内部的に必ず `ornament` オブジェクトを持つ。
- 初期状態（プレーンモード）：
  - `mode = "plain"`
  - `events` は 1つだけ（t=0, pitch=基音, vel=ステップのベロシティ）
- 拡張状態（拡張モード）：
  - `mode = "extended"`
  - `events` は複数
  - 各イベント：`t`（オーナメント内部時間）, `pitch`, `vel`, `dur`
  - `internalDuration` でオーナメント全体の長さを管理

### 3.2 時間挙動（followMode）

オーナメントが次のステップにどう影響するか：

- `overlap` … はみ出しても次のステップは通常通り開始
- `cut` … 次のステップが来たらオーナメントを強制終了
- `wait` … **オーナメントが終わるまで次のステップ開始を遅らせる**

`wait` により、ティハイ的な挙動や、拍の主導権をオーナメントが握る現象を再現。

### 3.3 再生モード（playMode）

- `oneShot` … 1回だけ再生
- `loop` … 指定回数または無限ループ
- `loopRoll` … ループ中もグローバルタイムは進み、
  解除で「本来の位置」に復帰する DJ 的 Loop Roll 挙動

### 3.4 編集方法（顔変形 UI の要点）

- オーナメント編集画面は、時間×ピッチのカーブ表示。
- 指ジェスチャー：
  - ノードドラッグ（横で t、縦で pitch）
  - ピンチで時間軸ズーム
  - フリックでノード削除／複製
- ツール：
  - PUSH（局所的に時間を押し出す）
  - STRETCH（区間を伸縮）
  - TWIST（局所的にイベント順序を軽くシャッフル）

### 3.5 パターン数

- オーナメントシーケンサーは 2小節パターンを：
  - **16パターン × 8バンク = 128パターン**
  として管理。
- 各トラック（ドラム、ベース、リード等）は、この 128 の中から
  任意のパターンを選び、ソングモードから参照する。

---

## 4. Live Take シーケンサー

### 4.1 コンセプト

- Live Take は、**メインシーケンサー + オーナメント + スワップ + グルーブ**
  などすべての処理結果として **実際に鳴ったノート列のみ** を録音する。
- 内部オートメーションや UI 操作は記録しない。
- 録音されたノート列は、**シンプルなシーケンサー**として扱う。

### 4.2 録音対象

- 1ノートあたり：
  - `time` … パターン開始からの絶対時間 or ステップ位置
  - `pitch` … MIDI ノート番号 or 相対スケール値
  - `gate` … 実際に出力されたゲート長
  - `velocity` … 出力ベロシティ
- オーナメント内部ノートもすべて「展開後の実ノート」として録音。

### 4.3 Live Take に対する介入（可能な変形）

Live Take は軽量性を保つため、変形は限定する：

- ✅ グルーブ歪み（GrvDepth、timeSkew）
- ✅ timeScale（0.5x / 1x / 2x など）
- ✅ Step Loop パターン（どの区間をループするか）
- ✅ 全体シフト（タイミングを前後にオフセット）
- ✅ 全体トランスポーズ（半音単位）

以下は **Live Take では行わない**：

- ❌ オーナメント内部構造の再編集
- ❌ ノートスワップフェーダーのカオス変形
- ❌ 装飾レイヤーをさらに重ねる

> マイクロ変形はあくまでオーナメント側に集約し、
> Live Take は「結果のフレーズの軽い揺らし」に特化する。

---

## 5. ノートスワップ & スワップフェーダー

### 5.1 プレイスタイルとしてのノートスワップ

- ノートスワップはモードではなく、**演奏スタイル**。
- 演奏中に：
  - ステップごとにノートミュート（アクティブなノート群を選別）
  - 残ったノートだけが **スワップフェーダー**の対象になる。

### 5.2 スワップスタイルボタン + フェーダー

- スワップスタイルは複数の“系”を持ち、**ボタンで切り替える**：
  - A：Neighbor Swap
  - B：Rotate Shift
  - C：Block Swap
  - D：Odd Loop / Odd Grid
  - E：Chaos-ish
- フェーダーは「そのスタイルの中を連続的に探索する」役割。
- ボタン＝世界観切り替え、フェーダー＝その世界の深さ・位置。

### 5.3 スワップ対象ルール

- ミュートされたノートは対象外。
- アクティブノートのみが入れ替え対象。
- 同一レーン内で完結（レーン間スワップは今は想定しない）。
- 装飾を持つステップは「塊」として扱い、丸ごと位置を入れ替える。

---

## 6. ライブパフォーマンス画面（Live Performance View）

### 6.1 画面構造

1. 上段：パフォーマンス用ボタン群
2. 中段：フェーダー & ノブ群
3. 下段：MINI シーケンサー表示 & ノートミュート

### 6.2 主な機能

- レーン別ミュート／ソロボタン
- スワップスタイル切替ボタン（A〜E）
- Step Loop パターンボタン
- テンポ Nudge ボタン
- スワップフェーダー（中央の大きなフェーダー）
- レーン別オーナメントノブ
- GrvDepth ノブ
- ステップレングスノブ（activeLength）
- レーン別ステップシフトノブ（shift）
- MINI シーケンサーでのノートミュート／状態の視覚化

### 6.3 編集画面との遷移

- 編集画面 ↔ ライブ画面は 1タップで切り替え。
- 編集画面で：
  - ノート配置、オーナメント編集、Live Take の細かい調整など。
- ライブ画面で：
  - ミュート、スワップ、グルーブ、Live Take 切り替えなど、演奏重視の操作。

---

## 7. ソングモード & パターン構造

### 7.1 パターン集合

- オーナメントシーケンサー：
  - 2小節パターン × 16 × 8バンク = 128パターン
- 各トラックは、これらパターンIDを参照して再生。

### 7.2 ソングモードの構想

- ソングモードでは、「どのパターンを何回繰り返し、どのタイミングで切り替えたか」を記録する。
- ドラムトラックで遊んでいる間：
  - パターン番号
  - 各パターンの繰り返し回数と切り替わり位置
  をリアルタイムで記録。
- ベーストラックでも同様に記録。
- その後、長すぎる部分を短くする簡易編集や、
  ドラムフィル用のパターンを途中に挿入する編集を行う。

### 7.3 コードトラック（ドラフト）

- ソングモードには、将来的に「コードトラック」も追加する構想。
- コードトラック：
  - 各小節ごとのコード or スケール情報を保持
  - ノートを持つトラックに「スケール縛り」を与える
  - ミュートすれば影響を無効化
- 実装難度が高ければ、まずは：
  - 上下方向への簡易ピッチシフト（相対トランスポーズ）をコードトラック的に使う案も有り。

---

## 8. 保存・ファイル名ルール

### 8.1 オーナメント / Live Take 保存

- ユーザーが気に入った瞬間に SAVE ボタンを押すだけ。
- 名前入力なし。
- ID形式：
  - `{lanePrefix}_{serial}{sub}`
  - 例：
    - `bs_012a`（ベース）
    - `dr_021`（ドラム）
    - `sd_007`（スネア）

`lanePrefix` の例：

- `bs` … Bass
- `dr` … Drum
- `kd` … Kick
- `sd` … Snare
- `pc` … Percussion
- `ld` … Lead
- `ch` … Chord / Comp
- `fx` … Effect / Noise

### 8.2 LIKE / UNLIKE システム

- 👍ボタンを押すごとに likeLevel を変更：
  - 0 → 1 → 2 → 3 → 0 …
- 👎ボタンは likeLevel を 0 に戻す、または低優先フラグを付与。
- ライブラリ画面では：
  - レーン種別（色 or アイコン）
  - ID
  - 👍数
  でリスト表示し、文字情報に頼らず感覚的に選べる。

---

## 9. 実装者向けメモ（軽量性・複雑さの境界）

- オーナメント内部はマイクロタイム＆複数イベントを持つが、
  レコード／再生はできるだけ軽量な配列操作に留める。
- Live Take はノート列に限定し、オートメーションを録音しないことで
  データ構造を単純化する。
- スワップフェーダーや GrvDepth は、
  **「現在のパターン状態に対して、再生直前に変換をかける」**
  一種のビュー変換として扱うと実装が楽。
- Android / Windows タブレットでのリアルタイム性能を考え、
  ポリフォニーやオーナメントの最大イベント数には適度な上限を設ける。
- 将来の拡張（コードトラックなど）は、既存データ構造を壊さずに
  「追加のモジュール」として差し込めるような API 風設計を意識する。

---

## 10. 付録：変態テンプレート群（ドラフト）

- 「キックは4つ打ち固定、ハットだけ
  1小節の中で 3分割 / 5分割 / 7分割される」テンプレート
- 「ベースは 0.5x timeScale、メロディは 0.25x」など
  異時間スケール組み合わせテンプレート
- オーナメントにあらかじめ民族音楽的装飾（ターン、モルデント、ティハイなど）を
  埋め込んだプリセット
- Step Loop パターン＆スワップスタイルの組み合わせプリセット
  （テンプレートとしてすぐ呼び出せるようにする）

これらは別途 JSON などでライブラリ化し、
ユーザーが「即変態的な挙動を呼び出せる」状態を目指す。
